<!DOCTYPE html>
<html>
  <head>
    <title>Introduction to functional programming with map &amp; walk</title>
    <meta charset="utf-8">
    <meta name="author" content="Brandon Hurr" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Introduction to functional programming with map &amp; walk
## üê±<br/>with purrr
### Brandon Hurr
### 2017/10/26

---




# Outline

- Basic data structures in R

- Why and when to write a function in R

- Functional Programming

- purrr::map

- purrr::walk

---
class: inverse, center, middle

# Data structures in R

---

# Atomic Vectors

Simple and strict; one data type at a time
- Used a lot
  - Logical 
  - Integer
  - Real (double, float)
  - Character

- Skipping these 
  - Complex
  - Raw


--

- What about factor? 
  - Integer vector with labels (levels)

--

Each type has its own NA


`NA` (logical), `NA_integer_`, `NA_real_`, `NA_character`, `NA_complex_`, `0` (raw)


---

# Lists
List can contain any of the atomic vectors AND lists!
.pull-left[

```r
# a simple list
a &lt;- list(a = 1:3
        , b = "a string"
        , c = pi
        , d = list(-1, -5))
```


Data frames are special types of lists.


]
  
.pull-right[
![](figures/lists-example.png)

Image credit: [R4DS](http://r4ds.had.co.nz/lists.html)
]

---
class: center, middle

# NULL


--
`NULL` is the absence of a vector


---

class: inverse, center, middle

# Notebook Time
Vectors and data types

---

# Subsetting Lists/Dataframes/Tibbles

Three main ways to subset a List/df/tibble
- `[` returns a list/df/tibble with those elements
- `[[` returns an element from list/df/tibble
- `$` same as `[[`

There are many caveats and ways to do things:
http://adv-r.had.co.nz/Subsetting.html

Tibbles are strict about what they return. df's are less so: 
https://cran.r-project.org/web/packages/tibble/vignettes/tibble.html

---

class: inverse, center, middle

# Notebook Time
Subsetting data

---
# Functions in R


```r
function01 &lt;- function(argument1, argument2, ...) {
  #body where you do stuff
  #output
}
```

- Assignment `function1 &lt;-`
- Function function `function() {}`
- formals or arguments
- Body
  - Code that solves your problem
- Output
  - last object is returned
  - can return something earlier with `return()`

Key realization: Functions are just like other R objects. You can use them in other functions.

http://adv-r.had.co.nz/Functions.html#function-components


---
# Why write a function?

```r
#Simple dataframe
df &lt;- data.frame(
  a = rnorm(10),
  b = rnorm(10),
  c = rnorm(10),
  d = rnorm(10)
)
# What are we doing here?
df$a &lt;- (df$a - min(df$a, na.rm = TRUE)) /  
  (max(df$a, na.rm = TRUE) - min(df$a, na.rm = TRUE))
df$b &lt;- (df$b - min(df$b, na.rm = TRUE)) /  
  (max(df$b, na.rm = TRUE) - min(df$b, na.rm = TRUE))
df$c &lt;- (df$c - min(df$a, na.rm = TRUE)) /  
  (max(df$c, na.rm = TRUE) - min(df$c, na.rm = TRUE))
df$d &lt;- (df$d - min(df$d, na.rm = TRUE)) /  
  (max(df$d, na.rm = TRUE) - min(df$d, na.rm = TRUE))
```
No shame in doing this because it works, but it's error prone and lengthy. 

---

# How many repeats is too many?

Hadley's reasoning is that if you've got 3 copies of the same code then it's time to write a function. (I think that is reasonable.)



--
Also consider if you might reuse this again in another place. That counts as a repeat too!

---
# Simplify and functionalize


```r
df$d &lt;- (df$d - min(df$d, na.rm = TRUE)) /  
  (max(df$d, na.rm = TRUE) - min(df$d, na.rm = TRUE))
```

--

```r
# pull out what's common, these are your arguments
x &lt;- (x - min(x, na.rm = TRUE)) /  
  (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
```

--

```r
#simplify more and refactor if that makes sense
x &lt;- (x - min(x, na.rm = TRUE)) /  
  diff(range(x, na.rm = TRUE))
```

--

```r
# rewrite as a function
rescale_0_1 &lt;- function(x) {
  (x - min(x, na.rm = TRUE)) /  
  diff(range(x, na.rm = TRUE))
}
```

---

# Test it

Use simple data that you know what the output should be.


```r
rescale_0_1 &lt;- function(x) {
  (x - min(x, na.rm = TRUE)) /  
  diff(range(x, na.rm = TRUE))
}

testvec &lt;- 1:11
testvec
```

```
##  [1]  1  2  3  4  5  6  7  8  9 10 11
```

```r
rescale_0_1(testvec)
```

```
##  [1] 0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0
```
Does the result make sense? 

---

# Put it to work for you


```r
df &lt;- data.frame(a = rnorm(10), b = rnorm(10), c = rnorm(10), d = rnorm(10))
rescale_0_1 &lt;- function(x) {
  (x - min(x, na.rm = TRUE)) /  
  diff(range(x, na.rm = TRUE))
}
out &lt;- df
out$a &lt;- rescale_0_1(df$a)
out$b &lt;- rescale_0_1(df$b)
out$c &lt;- rescale_0_1(df$c)
out$d &lt;- rescale_0_1(df$d)
out
```

```
##            a         b         c          d
## 1  0.8026493 1.0000000 0.3082703 1.00000000
## 2  0.7956673 0.2506672 0.1422022 0.45942834
## 3  1.0000000 0.6486570 0.7816751 0.70341964
## 4  0.3943699 0.1995764 0.3050600 0.44593162
## 5  0.6312579 0.5671313 1.0000000 0.98255179
## 6  0.5020093 0.4564469 0.6722143 0.00000000
## 7  0.0000000 0.6963666 0.6816609 0.56849032
## 8  0.3069656 0.2349646 0.0000000 0.49915315
## 9  0.1434753 0.0000000 0.3188515 0.40841712
## 10 0.6773657 0.1536463 0.5289502 0.08300282
```

---

# Function Writing Best Practices

- Make sure it does what you want it to do

- Use good names
  - functions do stuff; use verbs
  - arguments are things; use nouns
  - don't overwrite existing functions
  
- Argument order matters
  - `tidyverse` assumes data input comes first
  - detail arguments come later (e.g. `na.rm = TRUE`)

- Make output clear and obvious

The Tidyverse style guide is here:
http://style.tidyverse.org/

---

# What if we could take those repeats away too? 

```r
out &lt;- df
out$a &lt;- rescale_0_1(df$a)
out$b &lt;- rescale_0_1(df$b)
out$c &lt;- rescale_0_1(df$c)
out$d &lt;- rescale_0_1(df$d)
out
```
The function simplified the call, but we're copying and pasting again. 

ü§î

---

# Iterate over a list

For Loop


```r
out &lt;- df #make a copy to store scaled data
for (i in 1:ncol(df)) { # loop through each element
  out[i] &lt;- rescale_0_1(df[[i]]) #apply function and store it to out
}
out
```

```
##            a         b         c          d
## 1  0.8026493 1.0000000 0.3082703 1.00000000
## 2  0.7956673 0.2506672 0.1422022 0.45942834
## 3  1.0000000 0.6486570 0.7816751 0.70341964
## 4  0.3943699 0.1995764 0.3050600 0.44593162
## 5  0.6312579 0.5671313 1.0000000 0.98255179
## 6  0.5020093 0.4564469 0.6722143 0.00000000
## 7  0.0000000 0.6963666 0.6816609 0.56849032
## 8  0.3069656 0.2349646 0.0000000 0.49915315
## 9  0.1434753 0.0000000 0.3188515 0.40841712
## 10 0.6773657 0.1536463 0.5289502 0.08300282
```


---
# seq_along
`seq_along()` generates the 1:end for you and handles 0 length 


```r
out &lt;- df #make a copy to store scaled data
for (i in seq_along(df)) {
  out[i] &lt;- rescale_0_1(df[[i]])
}
out
```

```
##            a         b         c          d
## 1  0.8026493 1.0000000 0.3082703 1.00000000
## 2  0.7956673 0.2506672 0.1422022 0.45942834
## 3  1.0000000 0.6486570 0.7816751 0.70341964
## 4  0.3943699 0.1995764 0.3050600 0.44593162
## 5  0.6312579 0.5671313 1.0000000 0.98255179
## 6  0.5020093 0.4564469 0.6722143 0.00000000
## 7  0.0000000 0.6963666 0.6816609 0.56849032
## 8  0.3069656 0.2349646 0.0000000 0.49915315
## 9  0.1434753 0.0000000 0.3188515 0.40841712
## 10 0.6773657 0.1536463 0.5289502 0.08300282
```


---

# Can we do better?

Iterate over df with `purrr::map`


```r
map(df, function(x) rescale_0_1(x))#map over the columns in df
```

```
## $a
##  [1] 0.8026493 0.7956673 1.0000000 0.3943699 0.6312579 0.5020093 0.0000000
##  [8] 0.3069656 0.1434753 0.6773657
## 
## $b
##  [1] 1.0000000 0.2506672 0.6486570 0.1995764 0.5671313 0.4564469 0.6963666
##  [8] 0.2349646 0.0000000 0.1536463
## 
## $c
##  [1] 0.3082703 0.1422022 0.7816751 0.3050600 1.0000000 0.6722143 0.6816609
##  [8] 0.0000000 0.3188515 0.5289502
## 
## $d
##  [1] 1.00000000 0.45942834 0.70341964 0.44593162 0.98255179 0.00000000
##  [7] 0.56849032 0.49915315 0.40841712 0.08300282
```

---

class: inverse, center, middle

![](figures/tim-and-eric-mind-blown.gif)

---
# purrr::map

`map` iterates over any list and always returns a list


```r
l = list(a=1:10, b = 10:100)
map(l, function(x) mean(x, na.rm = TRUE))
```

```
## $a
## [1] 5.5
## 
## $b
## [1] 55
```
Arguments/formals
  - `.x` list (or vector) to iterate over
  - `.f` function to apply over that list
  - `...` things that get passed from map() to .f

The names `.x` and `.f` are intentionally weird because they are unlikely to collide with other names passed through `...` to `.f`.
---

# more maps

Other types of `map` that return specific things
  - `map_lgl` logical 
  - `map_int` integer 
  - `map_dbl` double 
  - `map_chr` character 
  - `map_dfc` bind as columns into df
  - `map_dfr` bind as rows into df
  

```r
l = list(a=1:10, b = 10:100)
map_dbl(l, function(x) mean(x, na.rm = TRUE))
```

```
##    a    b 
##  5.5 55.0
```


```r
map_lgl(l, function(x) mean(x, na.rm = TRUE))
```

```
## Error: Can't coerce element 1 from a double to a logical
```

These functions are "type-safe" and will fail with incorrect return type.

---

# Another example, assemble df from list output 

```r
map_dfc(df, function(x) rescale_0_1(x))#map over the columns in df
```

```
## # A tibble: 10 x 4
##            a         b         c          d
##        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
##  1 0.8026493 1.0000000 0.3082703 1.00000000
##  2 0.7956673 0.2506672 0.1422022 0.45942834
##  3 1.0000000 0.6486570 0.7816751 0.70341964
##  4 0.3943699 0.1995764 0.3050600 0.44593162
##  5 0.6312579 0.5671313 1.0000000 0.98255179
##  6 0.5020093 0.4564469 0.6722143 0.00000000
##  7 0.0000000 0.6963666 0.6816609 0.56849032
##  8 0.3069656 0.2349646 0.0000000 0.49915315
##  9 0.1434753 0.0000000 0.3188515 0.40841712
## 10 0.6773657 0.1536463 0.5289502 0.08300282
```

---

# Function definition shortcuts

Full anonymous function definition

```r
l = list(a=1:10, b = 10:100)
map_dbl(l, function(x) mean(x, na.rm = TRUE))
```
Function name only, parameters passed through `...`

```r
map_dbl(l, mean, na.rm = TRUE)
```
As a formula, object is passed as `.` or `.x`

```r
map_dbl(l, ~mean(., na.rm = TRUE))
```

```r
map_dbl(l, ~mean(.x, na.rm = TRUE))
```

```
##    a    b 
##  5.5 55.0
```

All return the same thing. 

---
# Map use case #1: Read in files

http://data.library.virginia.edu/getting-started-with-the-purrr-package-in-r/


```r
#this will work if you clone the github repository
fileloc &lt;- file.path(getwd(), "stocks")
#create a list of files to read in that end in csv
files &lt;- list.files(fileloc, pattern = "csv$", full.names = TRUE) 

#this reads in each csv independently into a list
dat2 &lt;- map(files, read.csv)

dat2
```

```
## [[1]]
##          Date   Open   High    Low  Close  Volume Adj.Close
## 1  2017-04-12 178.25 178.25 175.94 176.05 2920000    176.05
## 2  2017-04-11 177.50 178.60 176.96 178.57 2259700    178.57
## 3  2017-04-10 179.00 179.97 177.48 177.56 2259500    177.56
## 4  2017-04-07 178.39 179.09 177.26 178.85 2704700    178.85
## 5  2017-04-06 177.56 178.22 177.12 177.37 2343600    177.37
## 6  2017-04-05 179.00 180.18 176.89 177.08 2387100    177.08
## 7  2017-04-04 176.88 178.79 176.76 178.70 2319200    178.70
## 8  2017-04-03 177.08 177.73 175.50 176.65 2933600    176.65
## 9  2017-03-31 178.02 178.18 176.81 176.86 2030400    176.86
## 10 2017-03-30 177.25 178.49 177.22 177.98 1627000    177.98
## 11 2017-03-29 177.40 177.99 176.97 177.63 1629300    177.63
## 12 2017-03-28 176.29 177.68 175.00 177.36 2231400    177.36
## 13 2017-03-27 174.37 176.44 173.75 176.10 2743800    176.10
## 14 2017-03-24 176.85 177.53 174.77 175.82 2386800    175.82
## 15 2017-03-23 177.34 177.85 176.59 177.26 2006400    177.26
## 16 2017-03-22 175.96 177.10 175.50 176.98 2505700    176.98
## 17 2017-03-21 179.99 180.25 175.50 175.96 3239600    175.96
## 18 2017-03-20 180.10 180.15 179.14 179.39 2062200    179.39
## 19 2017-03-17 178.31 180.38 178.17 180.10 5037400    180.10
## 20 2017-03-16 179.82 180.00 177.64 178.19 3100700    178.19
## 21 2017-03-15 179.00 179.24 177.97 178.71 3569000    178.71
## 22 2017-03-14 178.54 179.69 177.71 178.73 2346700    178.73
## 23 2017-03-13 177.16 179.19 177.07 179.05 3499000    179.05
## 
## [[2]]
##          Date   Open   High    Low  Close  Volume Adj.Close
## 1  2017-04-12 171.04 171.20 170.02 170.66 3276900    170.66
## 2  2017-04-11 170.65 171.23 168.98 170.58 4890200    170.58
## 3  2017-04-10 172.53 172.56 171.00 171.20 3715300    171.20
## 4  2017-04-07 172.08 172.93 171.28 172.14 3556000    172.14
## 5  2017-04-06 173.47 173.47 172.25 172.45 3416100    172.45
## 6  2017-04-05 174.70 176.33 172.81 172.88 6199500    172.88
## 7  2017-04-04 173.52 174.96 173.26 174.52 3097400    174.52
## 8  2017-04-03 173.82 174.87 173.38 174.50 4271600    174.50
## 9  2017-03-31 173.98 174.95 173.69 174.14 2911200    174.14
## 10 2017-03-30 173.86 174.59 173.69 173.86 3153000    173.86
## 11 2017-03-29 174.30 174.49 173.46 173.94 3039600    173.94
## 12 2017-03-28 173.94 175.00 173.00 174.51 3506300    174.51
## 13 2017-03-27 172.69 174.16 172.09 173.77 3217700    173.77
## 14 2017-03-24 175.12 175.50 173.39 173.83 3178900    173.83
## 15 2017-03-23 174.43 175.67 173.56 174.82 3615400    174.82
## 16 2017-03-22 174.04 175.06 172.80 174.78 3426800    174.78
## 17 2017-03-21 176.01 176.23 173.84 173.88 3883700    173.88
## 18 2017-03-20 175.65 176.18 175.14 175.70 2334400    175.70
## 19 2017-03-17 176.29 176.79 175.65 175.65 5843800    175.65
## 20 2017-03-16 178.46 179.00 176.82 177.24 4263800    177.24
## 21 2017-03-15 175.71 176.28 174.75 175.81 3695200    175.81
## 22 2017-03-14 176.18 176.82 175.21 175.72 3144300    175.72
## 23 2017-03-13 177.85 178.06 176.42 176.46 3428900    176.46
## 
## [[3]]
##          Date   Open   High    Low  Close   Volume Adj.Close
## 1  2017-04-12 124.54 125.46 124.36 125.40  5492900    125.40
## 2  2017-04-11 124.26 124.79 123.95 124.22  4122600    124.22
## 3  2017-04-10 124.87 124.95 124.23 124.34  4361800    124.34
## 4  2017-04-07 125.12 125.47 124.83 124.92  3602600    124.92
## 5  2017-04-06 124.85 125.46 124.50 125.05  4324200    125.05
## 6  2017-04-05 124.72 125.60 124.41 124.80  5515700    124.80
## 7  2017-04-04 124.51 124.77 124.22 124.68  5318500    124.68
## 8  2017-04-03 124.73 125.31 124.28 124.69  4956400    124.69
## 9  2017-03-31 124.11 124.83 124.03 124.55  5649900    124.55
## 10 2017-03-30 124.74 125.43 124.28 124.66  4670200    124.66
## 11 2017-03-29 125.05 125.33 124.36 124.92  3895400    124.92
## 12 2017-03-28 125.62 125.78 124.78 125.66  5231500    125.66
## 13 2017-03-27 125.16 126.14 125.15 125.80  4989900    125.80
## 14 2017-03-24 125.86 126.36 125.13 125.48  6405700    125.48
## 15 2017-03-23 126.10 127.00 125.66 125.90  8489100    125.90
## 16 2017-03-22 127.05 127.65 126.21 126.26 10204600    126.26
## 17 2017-03-21 128.38 128.45 127.14 127.25  7526800    127.25
## 18 2017-03-20 128.04 128.42 127.97 128.07  5378100    128.07
## 19 2017-03-17 128.45 128.94 127.95 128.06 13193000    128.06
## 20 2017-03-16 128.44 128.70 127.77 128.46  7575200    128.46
## 21 2017-03-15 127.05 129.00 126.60 128.96  8207200    128.96
## 22 2017-03-14 126.86 127.75 126.77 127.05  7598700    127.05
## 23 2017-03-13 125.83 126.95 125.79 126.68  7002300    126.68
```
---
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {window.dispatchEvent(new Event('resize'));});
(function() {var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler"); if (!r) return; s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }"; d.head.appendChild(s);})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
